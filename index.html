<!DOCTYPE html>
<html>
<head>
  <title>GoloNido</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    
    /* Admin Panel Styles */
    #adminPanel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    #adminPanel.active {
      display: flex;
    }
    
    .admin-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    
    .admin-header h1 {
      margin: 0;
      color: #333;
    }
    
    .admin-close {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .admin-close:hover {
      background-color: #cc0000;
    }
    
    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    
    .admin-tab-btn {
      padding: 10px 20px;
      background-color: #f0f0f0;
      border: none;
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      font-size: 14px;
      font-weight: bold;
    }
    
    .admin-tab-btn.active {
      background-color: #0066FF;
      color: white;
    }
    
    .admin-tab-content {
      display: none;
    }
    
    .admin-tab-content.active {
      display: block;
    }
    
    .nidos-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .nidos-table th, .nidos-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    .nidos-table th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    
    .nidos-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .admin-delete-btn, .admin-view-btn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .admin-delete-btn {
      background-color: #ff4444;
      color: white;
    }
    
    .admin-delete-btn:hover {
      background-color: #cc0000;
    }
    
    .admin-view-btn {
      background-color: #0066FF;
      color: white;
    }
    
    .admin-view-btn:hover {
      background-color: #0052cc;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #0066FF;
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #0066FF;
    }
    
    .admin-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
      z-index: 999;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .admin-button:hover {
      background-color: #555;
    }
    
    .report-section {
      background-color: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #ff9800;
    }
    
    .report-btn {
      padding: 5px 10px;
      margin-top: 5px;
      background-color: #ff9800;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
    }
    
    .report-btn:hover {
      background-color: #e68900;
    }
    
    /* Hamburger Menu Button */
    .hamburger-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 20px;
      z-index: 999;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .hamburger-button:hover {
      background-color: #555;
    }
    
    .hamburger-button span {
      width: 25px;
      height: 3px;
      background-color: white;
      border-radius: 2px;
    }
    
    /* Info Panel */
    #infoPanel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    
    #infoPanel.active {
      display: flex;
    }
    
    .info-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #0066FF;
      padding-bottom: 10px;
    }
    
    .info-header h1 {
      margin: 0;
      color: #333;
      font-size: 28px;
    }
    
    .info-close {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .info-close:hover {
      background-color: #cc0000;
    }
    
    .info-subtitle {
      font-size: 16px;
      color: #0066FF;
      font-weight: bold;
      margin: 15px 0 10px 0;
    }
    
    .info-text {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
      margin: 15px 0;
    }
    
    .info-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .info-stat-card {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #0066FF;
      text-align: center;
    }
    
    .info-stat-card h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 12px;
    }
    
    .info-stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #0066FF;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Admin Panel -->
  <div id="adminPanel">
    <div class="admin-content">
      <div class="admin-header">
        <h1>Panel de Administración</h1>
        <button class="admin-close" onclick="cerrarAdminPanel()">Cerrar</button>
      </div>
      
      <div class="admin-tabs">
        <button class="admin-tab-btn active" onclick="cambiarTabAdmin('nidos')">Nidos</button>
        <button class="admin-tab-btn" onclick="cambiarTabAdmin('estadisticas')">Estadísticas</button>
        <button class="admin-tab-btn" onclick="cambiarTabAdmin('reportes')">Reportes</button>
      </div>
      
      <!-- Tab Nidos -->
      <div id="tab-nidos" class="admin-tab-content active">
        <h2>Gestión de Nidos</h2>
        <table class="nidos-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>Ubicación</th>
              <th>Usuario</th>
              <th>Fecha Creación</th>
              <th>Reportes</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="nidosTableBody">
            <tr><td colspan="7">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Tab Estadísticas -->
      <div id="tab-estadisticas" class="admin-tab-content">
        <h2>Estadísticas</h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <h3>Total de Nidos</h3>
            <div class="stat-value" id="statTotalNidos">0</div>
          </div>
          <div class="stat-card">
            <h3>Nidos de Golondrina</h3>
            <div class="stat-value" id="statGolondrinas">0</div>
          </div>
          <div class="stat-card">
            <h3>Otros Nidos</h3>
            <div class="stat-value" id="statOtrosNidos">0</div>
          </div>
          <div class="stat-card">
            <h3>Usuarios Activos</h3>
            <div class="stat-value" id="statUsuarios">0</div>
          </div>
        </div>
        <h3 style="margin-top: 30px;">Nidos por Usuario</h3>
        <div id="statsUsers"></div>
      </div>
      
      <!-- Tab Reportes -->
      <div id="tab-reportes" class="admin-tab-content">
        <h2>Nidos Reportados</h2>
        <div id="reportesContainer">
          <p>Cargando reportes...</p>
        </div>
      </div>
    </div>
  </div>
  
  <button class="hamburger-button" onclick="abrirInfoPanel()">
    <span></span>
    <span></span>
    <span></span>
  </button>
  
  <!-- Info Panel -->
  <div id="infoPanel">
    <div class="info-content">
      <div class="info-header">
        <h1>GoloNidos</h1>
        <button class="info-close" onclick="cerrarInfoPanel()">Cerrar</button>
      </div>
      <h2 class="info-subtitle">Información del proyecto</h2>
      <p class="info-text">Nuestro proyecto se centra en la investigación, observación y recopilación de información sobre los nidos de las aves, con especial atención a los construidos por las golondrinas, analizando sus características y ubicación.</p>
      
      <h2 class="info-subtitle" style="margin-top: 30px;">Estadísticas</h2>
      <div class="info-stats-grid">
        <div class="info-stat-card">
          <h3>Total de Nidos</h3>
          <div class="info-stat-value" id="infoStatTotalNidos">0</div>
        </div>
        <div class="info-stat-card">
          <h3>Golondrinas</h3>
          <div class="info-stat-value" id="infoStatGolondrinas">0</div>
        </div>
        <div class="info-stat-card">
          <h3>Otros Nidos</h3>
          <div class="info-stat-value" id="infoStatOtrosNidos">0</div>
        </div>
      </div>
    </div>
  </div>
  
  <button class="admin-button" onclick="abrirAdminPanel()">⚙️</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Variables globales
    let globalSupabase = null;
    let globalUserId = null;
    
    // Esperar a que Supabase cargue
    function inicializar() {
      if (!window.supabase) {
        setTimeout(inicializar, 100);
        return;
      }

      // Configurar Supabase
      const supabaseUrl = 'https://jazskweggyiqbhgvxcou.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphenNrd2VnZ3lpcWJoZ3Z4Y291Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDkxMjYsImV4cCI6MjA4NTEyNTEyNn0.YkmVFYUQ8j0GZJsQTmLFAhM1Rm9Gyp6w_QBk3wcnkAc';
      globalSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const supabase = globalSupabase;

      // Generar ID único para el usuario (sin auth)
      let userId = localStorage.getItem('golonido_user_id');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('golonido_user_id', userId);
      }
      globalUserId = userId;

      var map = L.map('map').setView([37.4889, -2.7711], 15);

      // Limitar el zoom y el desplazamiento del mapa a Baza
      var mapBounds = L.latLngBounds(
        [37.470, -2.800],  // Suroeste
        [37.510, -2.730]   // Noreste
      );
      
      map.setMaxBounds(mapBounds);
      map.setMinZoom(14);
      map.setMaxZoom(18);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);

      // Límites de Baza en forma de L
      var rect1 = {
        north: 37.505114,
        south: 37.475114,
        east: -2.755077,
        west: -2.790277
      };

      var rect2 = {
        north: 37.505114,
        south: 37.495114,
        east: -2.738077,
        west: -2.755077
      };

      // Función para verificar si un punto está dentro de Baza
      function isInsideBaza(lat, lng) {
        var inRect1 = lat <= rect1.north && lat >= rect1.south && lng >= rect1.west && lng <= rect1.east;
        var inRect2 = lat <= rect2.north && lat >= rect2.south && lng >= rect2.west && lng <= rect2.east;
        return inRect1 || inRect2;
      }

      L.polygon([
        [rect1.north, rect1.west],
        [rect1.north, rect2.east],
        [rect2.south, rect2.east],
        [rect2.south, rect1.east],
        [rect1.south, rect1.east],
        [rect1.south, rect1.west]
      ], {
        color: 'red',
        weight: 2,
        opacity: 0.8,
        fill: false
      }).addTo(map);

      // Crear un límite rojo transparente fuera de Baza
      var maxBounds = {
        north: 38,
        south: 37,
        east: -2.7,
        west: -3
      };

      // Rectángulo norte
      L.rectangle([[rect1.north, maxBounds.west], [maxBounds.north, maxBounds.east]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // Rectángulo sur
      L.rectangle([[maxBounds.south, maxBounds.west], [rect1.south, maxBounds.east]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // Rectángulo oeste
      L.rectangle([[rect1.north, maxBounds.west], [rect1.south, rect1.west]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // Rectángulo este
      L.rectangle([[rect2.north, rect2.east], [rect2.south, maxBounds.east]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // Área entre los dos rectángulos
      L.rectangle([[rect2.south, rect2.west], [rect1.south, rect2.east]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // Rectángulo al este
      L.rectangle([[rect2.south, rect2.east], [rect1.south, maxBounds.east]], {
        color: 'red',
        weight: 0,
        fill: true,
        fillColor: 'red',
        fillOpacity: 0.1
      }).addTo(map);

      // SVG para markers
      var golondrinaSVG = '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 341 341"><g><path d="M 113.01 260.47 C111.01,264.61 108.00,267.22 108.00,264.82 C108.00,263.10 113.02,253.23 114.54,251.97 C115.28,251.36 115.66,250.27 115.39,249.57 C115.12,248.86 116.24,246.08 117.89,243.39 C127.60,227.57 128.87,222.63 124.33,218.43 C120.98,215.33 118.08,214.58 112.38,215.36 C107.55,216.02 94.05,220.28 90.00,222.42 C88.62,223.14 85.03,224.50 82.00,225.43 C76.65,227.07 68.28,230.32 64.76,232.11 C63.81,232.60 62.07,233.00 60.89,233.00 C59.11,233.00 58.96,232.75 60.00,231.50 C60.68,230.68 61.86,230.00 62.62,230.00 C63.38,230.00 64.00,229.59 64.00,229.08 C64.00,228.57 65.34,227.86 66.99,227.50 C68.63,227.14 70.20,226.48 70.48,226.03 C70.76,225.58 74.03,223.80 77.74,222.07 C81.46,220.34 85.18,218.56 86.00,218.11 C98.60,211.34 101.85,209.48 103.87,207.88 C105.19,206.85 106.88,206.00 107.63,206.00 C108.39,206.00 109.00,205.62 109.00,205.15 C109.00,204.69 110.80,203.49 113.00,202.50 C115.20,201.51 117.00,200.36 117.00,199.96 C117.00,199.55 118.77,198.51 120.93,197.64 C123.09,196.78 125.23,195.45 125.68,194.69 C126.13,193.94 127.85,192.48 129.50,191.45 C131.15,190.43 134.07,188.26 136.00,186.63 C140.34,182.96 152.00,165.31 152.00,162.41 C152.00,159.79 148.38,155.00 146.41,155.00 C145.61,155.00 143.17,153.82 140.98,152.37 C138.18,150.52 137.00,149.02 137.00,147.34 C137.00,145.69 136.20,144.65 134.42,143.97 C131.55,142.88 129.00,140.63 129.00,139.19 C129.00,138.67 127.69,137.70 126.09,137.04 C124.48,136.37 122.93,134.84 122.62,133.63 C122.29,132.31 120.75,130.95 118.78,130.23 C116.98,129.57 114.60,127.67 113.50,126.00 C112.40,124.33 109.78,121.82 107.67,120.41 C105.57,119.01 103.24,116.43 102.50,114.66 C101.69,112.72 99.56,110.56 97.08,109.17 C93.73,107.28 93.00,106.34 93.00,103.89 C93.00,102.14 92.07,99.98 90.75,98.65 C86.73,94.60 83.00,89.17 83.00,87.37 C83.00,86.40 80.73,83.47 77.96,80.87 C73.59,76.77 72.96,75.69 73.16,72.66 C73.33,70.18 72.56,67.97 70.48,64.96 C68.39,61.96 67.55,59.54 67.53,56.52 C67.50,53.00 66.96,51.84 64.26,49.57 C61.10,46.90 61.06,46.78 62.58,43.85 C63.99,41.12 63.98,40.62 62.50,38.36 C61.60,36.99 60.00,35.00 58.93,33.93 C56.64,31.64 56.43,29.16 58.46,28.38 C60.08,27.76 63.84,30.12 71.66,36.67 C74.50,39.05 77.08,41.00 77.40,41.00 C78.25,41.00 89.44,49.62 90.95,51.44 C91.66,52.30 92.65,53.00 93.14,53.00 C94.47,53.00 107.67,61.82 112.95,66.24 C114.61,67.63 119.08,70.21 123.71,72.44 C125.47,73.29 130.25,76.02 134.33,78.50 C138.41,80.97 142.30,83.00 142.96,83.00 C144.08,83.00 155.61,87.69 160.82,90.26 C162.09,90.89 168.17,96.30 174.32,102.27 C180.47,108.25 186.51,113.83 187.74,114.68 C191.10,116.99 194.58,115.60 200.57,109.56 C211.21,98.84 220.59,93.60 229.00,93.69 C235.31,93.75 240.77,94.82 241.59,96.14 C242.14,97.04 239.75,104.21 237.29,109.00 C236.59,110.38 236.01,112.07 236.01,112.78 C236.00,114.32 228.98,127.89 227.82,128.61 C227.37,128.89 227.00,130.47 227.00,132.11 C227.00,135.25 227.92,135.82 243.67,142.47 C248.84,144.65 254.85,150.09 258.60,156.00 C260.17,158.48 261.92,161.22 262.48,162.11 C263.04,163.00 264.79,166.15 266.38,169.11 C267.96,172.07 269.87,174.86 270.63,175.30 C271.38,175.74 272.01,176.64 272.02,177.30 C272.03,177.96 274.51,181.54 277.52,185.25 C280.53,188.96 283.00,192.41 283.00,192.91 C283.00,193.99 294.20,206.08 306.25,217.99 C317.15,228.77 318.13,232.66 308.75,227.87 C305.12,226.02 304.16,225.90 301.23,226.96 C298.07,228.10 297.61,227.97 293.28,224.59 C288.90,221.18 286.23,219.95 287.44,221.90 C287.74,222.39 287.28,223.06 286.41,223.40 C283.12,224.66 280.19,223.90 277.16,221.00 C274.01,218.00 270.74,217.25 268.08,218.93 C266.09,220.19 262.36,218.56 257.82,214.46 C253.44,210.50 253.23,210.45 250.20,212.57 C248.07,214.07 247.81,213.99 245.25,211.07 C243.32,208.87 241.67,208.00 239.43,208.00 C237.31,208.00 235.28,207.03 233.16,205.00 C231.29,203.21 228.95,202.00 227.37,202.00 C225.82,202.00 223.75,200.94 222.35,199.44 C220.76,197.72 219.35,197.07 218.09,197.47 C217.06,197.80 215.58,197.44 214.81,196.66 C212.83,194.68 207.42,192.00 205.41,192.00 C204.48,192.00 200.81,190.16 197.25,187.92 C189.75,183.18 189.06,183.22 180.17,188.97 C176.74,191.19 173.30,193.00 172.53,193.00 C171.75,193.00 170.88,193.38 170.59,193.85 C170.30,194.32 166.65,196.46 162.48,198.60 C158.32,200.75 154.18,203.62 153.29,205.00 C152.40,206.38 148.91,210.65 145.53,214.50 C142.15,218.35 137.64,224.20 135.51,227.50 C133.38,230.80 131.37,233.73 131.06,234.00 C128.17,236.53 121.47,247.80 122.34,248.67 C122.61,248.94 121.09,250.73 118.97,252.64 C116.85,254.56 114.17,258.08 113.01,260.47 ZM 107.00 270.45 C107.00,271.18 106.17,272.80 105.16,274.05 C102.59,277.22 101.38,274.86 103.63,271.06 C105.34,268.15 107.00,267.85 107.00,270.45 Z" fill="rgb(1,119,252)"/></g></svg>';
      var nidoSVG = '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 341 341"><g><path d="M 188.00 239.47 C183.88,240.31 178.70,240.94 176.50,240.87 C168.60,240.61 155.60,238.95 149.96,237.49 C142.69,235.61 140.53,235.62 138.60,237.54 C137.21,238.93 136.75,238.92 133.90,237.45 C131.66,236.29 129.49,236.00 126.49,236.45 C122.09,237.11 119.92,235.48 122.19,233.21 C123.72,231.68 122.40,230.25 118.74,229.45 C109.73,227.48 95.35,218.48 87.81,210.08 C85.07,207.03 83.39,206.00 81.15,206.00 C78.33,206.00 73.18,202.67 70.33,199.01 C69.41,197.82 69.48,197.32 70.67,196.65 C71.59,196.13 72.63,196.23 73.30,196.90 C73.90,197.50 74.99,198.00 75.70,198.00 C78.31,198.00 76.89,195.05 72.59,191.52 C68.74,188.36 65.28,183.82 68.01,185.51 C68.56,185.84 69.00,185.68 69.00,185.15 C69.00,183.80 72.97,184.94 76.26,187.23 C81.21,190.68 81.72,188.51 77.00,184.11 C74.53,181.79 70.44,177.92 67.91,175.49 C65.39,173.06 62.10,170.61 60.60,170.04 C59.11,169.47 58.15,168.56 58.48,168.02 C58.82,167.49 57.65,165.46 55.88,163.52 C53.16,160.53 51.99,159.98 48.09,159.88 C45.57,159.82 42.15,159.44 40.50,159.04 L 37.50 158.32 L 40.50 157.52 C47.13,155.76 47.42,155.24 44.05,151.40 C40.35,147.19 40.28,146.01 43.50,142.18 C46.44,138.69 46.54,137.76 44.38,134.46 C42.94,132.26 42.93,132.00 44.33,132.00 C45.19,132.00 47.07,130.98 48.52,129.74 C51.12,127.50 51.14,127.42 49.63,123.05 C47.87,117.94 48.18,117.00 51.63,117.00 C53.64,117.00 54.02,116.62 53.53,115.08 C52.98,113.35 55.03,111.78 58.16,111.55 C58.52,111.52 59.81,110.24 61.02,108.70 C63.04,106.13 63.37,106.03 64.94,107.45 C65.89,108.30 66.87,108.89 67.12,108.75 C67.37,108.61 66.72,109.29 65.68,110.25 C64.63,111.21 62.82,112.00 61.64,112.01 C60.19,112.01 58.83,113.26 57.41,115.87 C55.40,119.57 55.39,119.76 57.15,120.86 C59.52,122.34 60.00,122.30 60.00,120.62 C60.00,118.67 63.99,116.27 68.60,115.44 C73.13,114.63 78.12,112.00 77.39,110.82 C77.11,110.37 75.01,110.00 72.73,110.00 C69.12,110.00 68.76,109.81 70.04,108.58 C72.28,106.40 78.93,105.65 79.64,107.50 C80.55,109.88 83.01,109.30 82.74,106.76 C82.53,104.80 83.18,104.39 88.00,103.42 C91.03,102.81 96.32,101.28 99.77,100.01 C106.45,97.57 108.37,97.83 105.66,100.82 C104.75,101.83 104.00,103.01 104.00,103.45 C104.00,103.88 108.61,103.95 114.25,103.61 C136.59,102.27 137.63,102.07 136.59,99.37 C136.17,98.27 136.86,98.00 139.58,98.18 C141.71,98.32 143.46,97.88 143.96,97.06 C145.01,95.37 148.00,96.41 148.00,98.47 C148.00,99.72 149.48,100.00 155.94,100.00 C163.22,100.00 166.85,101.08 163.76,102.34 C162.78,102.73 162.80,103.06 163.87,103.81 C165.25,104.77 164.61,104.84 136.00,106.71 L 124.50 107.46 L 133.00 108.14 C148.54,109.37 180.51,110.28 179.75,109.47 C179.34,109.03 177.58,108.52 175.85,108.33 C172.60,107.97 170.00,106.44 170.00,104.88 C170.00,103.66 176.37,103.77 177.61,105.01 C178.17,105.57 181.30,106.26 184.56,106.54 C187.83,106.83 192.86,107.32 195.75,107.63 C198.92,107.97 201.00,107.80 201.00,107.20 C201.00,106.03 198.47,105.34 191.00,104.47 C187.98,104.12 184.15,103.43 182.50,102.94 C180.85,102.46 177.63,101.96 175.35,101.84 C172.41,101.69 171.35,101.24 171.71,100.31 C171.99,99.59 172.73,98.97 173.36,98.94 C173.99,98.91 172.02,97.74 169.00,96.34 C163.92,93.99 163.67,93.72 165.68,92.78 C167.97,91.71 177.00,92.57 177.00,93.85 C177.00,94.50 179.83,95.51 191.57,99.07 C196.80,100.65 202.67,99.89 201.37,97.80 C200.26,95.99 204.41,98.74 206.43,101.14 C207.94,102.94 208.46,103.12 208.83,101.97 C209.55,99.71 210.92,99.17 217.73,98.44 C222.78,97.90 223.98,97.44 223.77,96.13 C223.58,94.99 224.09,94.61 225.50,94.87 C226.60,95.07 230.81,95.38 234.85,95.55 C238.89,95.72 242.49,96.19 242.85,96.59 C243.21,96.99 242.98,97.03 242.35,96.67 C241.72,96.31 240.95,96.70 240.62,97.54 C240.29,98.41 240.67,99.32 241.51,99.64 C244.70,100.87 241.59,102.20 236.97,101.59 C230.89,100.78 220.81,101.92 221.29,103.36 C221.73,104.70 226.24,105.62 236.00,106.38 C244.69,107.06 246.77,106.31 245.07,103.13 C244.03,101.18 244.18,101.00 246.86,101.00 C248.65,101.00 250.03,101.64 250.42,102.64 C250.96,104.07 250.82,104.11 249.27,102.92 C248.30,102.17 248.59,102.78 249.92,104.28 C251.26,105.78 253.06,107.00 253.92,107.00 C254.79,107.01 256.88,107.85 258.57,108.88 C260.26,109.91 262.73,111.07 264.07,111.47 C265.41,111.87 268.17,112.90 270.21,113.77 C274.42,115.56 276.15,118.05 272.68,117.31 C270.62,116.88 270.64,116.96 273.00,118.85 C274.38,119.96 276.35,121.49 277.38,122.26 C278.63,123.19 279.43,125.34 279.75,128.58 C280.01,131.29 280.58,134.18 281.02,135.01 C281.47,135.88 281.32,137.19 280.66,138.07 C279.47,139.65 271.18,144.00 269.36,144.00 C267.73,144.00 263.75,148.73 264.83,149.39 C266.35,150.34 278.19,146.29 281.27,143.77 C284.38,141.21 286.56,135.38 284.66,134.68 C283.80,134.36 283.82,133.91 284.75,132.93 C285.44,132.20 286.00,130.15 286.00,128.38 C286.00,125.82 285.18,124.52 281.98,121.98 C278.87,119.52 278.02,118.20 278.23,116.19 C278.47,113.83 277.80,113.28 271.15,110.40 C267.11,108.64 263.36,106.76 262.82,106.22 C261.22,104.62 263.51,103.86 266.48,104.99 C267.94,105.55 270.20,106.00 271.51,106.00 C272.82,106.00 274.51,106.90 275.28,107.99 C276.05,109.09 278.11,110.27 279.86,110.62 C281.61,110.97 283.28,111.65 283.58,112.13 C283.88,112.61 284.80,113.00 285.63,113.00 C287.18,113.00 290.00,115.30 290.00,116.56 C290.00,116.94 291.58,119.00 293.50,121.13 C295.42,123.26 297.00,125.90 297.00,127.00 C297.00,128.10 297.39,129.00 297.86,129.00 C299.08,129.00 298.00,134.20 296.40,136.05 C294.28,138.49 291.75,146.42 292.96,146.82 C294.91,147.47 294.00,149.86 290.99,152.01 C289.33,153.19 288.23,154.57 288.55,155.08 C288.86,155.59 287.97,156.44 286.56,156.98 C285.15,157.51 283.95,158.52 283.89,159.23 C283.67,161.80 283.96,165.57 284.57,168.16 C285.06,170.23 284.73,171.07 283.10,171.95 C281.94,172.56 281.00,173.67 281.00,174.41 C281.00,175.15 280.29,176.34 279.43,177.06 C278.05,178.21 278.30,178.63 281.52,180.57 L 285.18 182.78 L 281.84 183.81 C280.00,184.37 276.86,185.11 274.85,185.44 C272.57,185.82 269.56,187.54 266.85,190.02 C262.67,193.83 262.57,194.04 264.43,195.48 C264.48,195.53 264.54,195.57 264.60,195.61 C265.40,196.24 265.88,196.61 265.87,196.96 C265.85,197.51 264.68,198.03 261.75,199.37 C259.69,200.32 257.94,201.52 257.88,202.05 C257.81,202.57 257.69,203.53 257.62,204.17 C257.56,204.81 256.45,205.41 255.17,205.51 C253.89,205.60 251.86,206.76 250.67,208.09 C249.48,209.42 246.26,212.31 243.51,214.50 C240.77,216.70 237.76,219.25 236.84,220.17 C235.91,221.10 234.22,222.35 233.08,222.96 C230.96,224.09 230.19,227.00 232.00,227.00 C232.55,227.00 233.00,227.43 233.00,227.95 C233.00,228.48 231.31,229.21 229.25,229.58 C227.19,229.95 224.82,230.62 224.00,231.06 C222.67,231.78 222.67,231.93 224.00,232.44 C224.82,232.76 227.49,233.36 229.92,233.77 C232.35,234.19 234.54,235.13 234.79,235.86 C235.32,237.45 226.37,236.99 216.36,234.91 C210.78,233.76 209.54,233.84 202.86,235.79 C198.81,236.97 192.12,238.63 188.00,239.47 Z" fill="rgb(6,176,42)"/></g></svg>';

      // Función para cargar nidos desde Supabase
      window.cargarNidos = async function cargarNidos() {
        try {
          console.log('Cargando nidos...');
          let { data: nidos, error } = await supabase.from('nidos').select('*');
          
          console.log('Respuesta de Supabase:', { nidos, error });

          if (error) {
            console.error('Error cargando nidos:', error);
            return;
          }

          if (!nidos || nidos.length === 0) {
            console.log('No hay nidos aún');
            return;
          }

          console.log('Cargando ' + nidos.length + ' nidos');

          nidos.forEach(nido => {
            try {
              console.log('Procesando nido:', nido);
              var svgContent = nido.tipo === 'Golondrina' ? golondrinaSVG : nidoSVG;
              
              var customIcon = L.divIcon({
                html: svgContent,
                iconSize: [40, 40],
                className: 'custom-marker'
              });

              var marker = L.marker([nido.lat, nido.lng], {icon: customIcon}).addTo(map);
              console.log('Marcador añadido en:', nido.lat, nido.lng);
              
              var markerContent = document.createElement('div');
              var deleteBtn = '';
              if (nido.user_id === userId) {
                deleteBtn = "<button class='deleteNidoBtn' data-nido-id='" + nido.id + "' style='margin-top:5px; padding:5px 10px; cursor:pointer; background-color: #ff4444; color: white; border: none; border-radius: 3px;'>Eliminar</button>";
              }
              var reportBtn = "<button class='reportNidoBtn' data-nido-id='" + nido.id + "' style='margin-top:5px; margin-left:5px; padding:5px 10px; cursor:pointer; background-color: #ff9800; color: white; border: none; border-radius: 3px;'>Reportar</button>";
              var tipoTexto = nido.tipo === 'Golondrina' ? 'Nido de Golondrina' : 'Otro nido';
              markerContent.innerHTML = tipoTexto + "<br><img src='" + nido.foto_url + "' style='width:200px; height:auto; margin-top:10px; border-radius:5px;'><br>" + deleteBtn + reportBtn;
              
              marker.bindPopup(markerContent);

              if (nido.user_id === userId) {
                setTimeout(function() {
                  var btn = markerContent.querySelector('.deleteNidoBtn');
                  if (btn) {
                    btn.onclick = async function(evt) {
                      evt.stopPropagation();
                      await eliminarNido(nido.id);
                      map.removeLayer(marker);
                      map.closePopup();
                    };
                  }
                }, 10);
              }
              
              // Evento para el botón de reportar
              setTimeout(function() {
                var reportBtn = markerContent.querySelector('.reportNidoBtn');
                if (reportBtn) {
                  reportBtn.onclick = async function(evt) {
                    evt.stopPropagation();
                    await reportarNido(nido.id);
                  };
                }
              }, 10);
            } catch (e) {
              console.error('Error procesando nido:', e);
            }
          });
        } catch (e) {
          console.error('Error en cargarNidos:', e);
        }
      }

      // Función para eliminar nido
      async function eliminarNido(nidoId) {
        try {
          let { error } = await supabase.from('nidos').delete().eq('id', nidoId);
          if (error) {
            alert('Error eliminando nido: ' + error.message);
          }
        } catch (e) {
          console.error('Error eliminando:', e);
          alert('Error eliminando nido: ' + e.message);
        }
      }

      // Función para reportar un nido
      async function reportarNido(nidoId) {
        try {
          let { data: nido, error: fetchError } = await supabase.from('nidos').select('reports_count').eq('id', nidoId).single();
          
          if (fetchError) {
            console.error('Error obteniendo nido:', fetchError);
            return;
          }

          const newCount = (nido.reports_count || 0) + 1;
          
          let { error } = await supabase.from('nidos').update({ reports_count: newCount }).eq('id', nidoId);
          
          if (error) {
            alert('Error reportando nido: ' + error.message);
          } else {
            alert('Nido reportado. Gracias por ayudar a mantener la comunidad segura.');
          }
        } catch (e) {
          console.error('Error reportando:', e);
        }
      }

      // Cargar nidos al abrir el mapa
      setTimeout(() => {
        window.cargarNidos();
      }, 500);

      map.on('click', function(e) {
        // Verificar si el click está dentro de Baza (forma de L)
        if (!isInsideBaza(e.latlng.lat, e.latlng.lng)) {
          alert('No puedes crear nidos fuera de Baza');
          return;
        }

        var optionsContent = document.createElement('div');
        optionsContent.innerHTML = "<strong>Selecciona el tipo:</strong><br><button class='typeBtn' data-type='Golondrina' style='margin:5px 5px 5px 0; padding:5px 10px; cursor:pointer;'>Nido de Golondrina</button><button class='typeBtn' data-type='Otro' style='margin:5px; padding:5px 10px; cursor:pointer;'>Otro Nido</button><br><input type='file' id='photoInput' accept='image/*' style='margin-top:10px;'>";
        
        var popup = L.popup()
          .setLatLng(e.latlng)
          .setContent(optionsContent)
          .openOn(map);
        
        var typeButtons = optionsContent.querySelectorAll('.typeBtn');
        typeButtons.forEach(function(btn) {
          btn.onclick = function(event) {
            event.stopPropagation();
            var type = this.getAttribute('data-type');
            var photoInput = document.getElementById('photoInput');
            var clickLat = e.latlng.lat;
            var clickLng = e.latlng.lng;
            
            if (photoInput.files.length === 0) {
              alert('Por favor selecciona una foto');
              return;
            }
            
            var file = photoInput.files[0];
            
            // Subir foto a Supabase Storage
            var fileName = Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_' + file.name;
            
            supabase.storage
              .from('fotos')
              .upload(fileName, file)
              .then(uploadRes => {
                if (uploadRes.error) {
                  alert('Error subiendo foto: ' + uploadRes.error.message);
                  return;
                }

                // Obtener URL pública de la foto
                const { data: publicUrl } = supabase.storage
                  .from('fotos')
                  .getPublicUrl(fileName);

                var photoUrl = publicUrl.publicUrl;

                // Guardar nido en la base de datos
                supabase.from('nidos').insert([
                  {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    tipo: type,
                    foto_url: photoUrl,
                    user_id: userId
                  }
                ]).select().then(insertRes => {
                  if (insertRes.error) {
                    alert('Error guardando nido: ' + insertRes.error.message);
                    console.error('Error insertando:', insertRes.error);
                    return;
                  }

                  console.log('Nido insertado:', insertRes);

                  if (!insertRes.data || insertRes.data.length === 0) {
                    alert('Error: No se pudo obtener el ID del nido');
                    console.error('No data returned from insert');
                    return;
                  }

                  map.closePopup();

                  var iconColor = type === 'Golondrina' ? '#0066FF' : '#00AA00';
                  
                  var customIcon = L.divIcon({
                    html: '<div style="background-color:' + iconColor + '; width:30px; height:30px; border-radius:50%; border:3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [30, 30],
                    className: 'custom-marker'
                  });
                  
                  var nidoId = insertRes.data[0].id;
                  var marker = L.marker([e.latlng.lat, e.latlng.lng], {icon: customIcon}).addTo(map);
                  
                  var markerContent = document.createElement('div');
                  var tipoTexto = type === 'Golondrina' ? 'Nido de Golondrina' : 'Otro nido';
                  markerContent.innerHTML = tipoTexto + "<br><img src='" + photoUrl + "' style='width:200px; height:auto; margin-top:10px; border-radius:5px;'><br><button class='deleteNidoBtn' data-nido-id='" + nidoId + "' style='margin-top:5px; padding:5px 10px; cursor:pointer; background-color: #ff4444; color: white; border: none; border-radius: 3px;'>Eliminar</button><button class='reportNidoBtn' data-nido-id='" + nidoId + "' style='margin-top:5px; margin-left:5px; padding:5px 10px; cursor:pointer; background-color: #ff9800; color: white; border: none; border-radius: 3px;'>Reportar</button>";
                  
                  var deleteBtn = markerContent.querySelector('.deleteNidoBtn');
                  deleteBtn.onclick = async function(evt) {
                    evt.stopPropagation();
                    await eliminarNido(nidoId);
                    map.removeLayer(marker);
                    map.closePopup();
                  };
                  
                  var reportBtn = markerContent.querySelector('.reportNidoBtn');
                  reportBtn.onclick = async function(evt) {
                    evt.stopPropagation();
                    await reportarNido(nidoId);
                  };
                  
                  marker.bindPopup(markerContent).openPopup();
                });
              });
          };
        });
      });
    }

    // Funciones del Panel de Administración
    window.abrirAdminPanel = function() {
      const password = prompt('Ingresa la contraseña del administrador:');
      if (password !== 'admin123') {
        alert('Contraseña incorrecta');
        return;
      }
      document.getElementById('adminPanel').classList.add('active');
      cargarDatosAdmin();
    };

    window.cerrarAdminPanel = function() {
      document.getElementById('adminPanel').classList.remove('active');
    };

    window.cambiarTabAdmin = function(tab) {
      // Ocultar todos los tabs
      document.querySelectorAll('.admin-tab-content').forEach(el => {
        el.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab-btn').forEach(el => {
        el.classList.remove('active');
      });
      
      // Mostrar el tab seleccionado
      document.getElementById('tab-' + tab).classList.add('active');
      event.target.classList.add('active');
      
      if (tab === 'reportes') {
        cargarReportes();
      }
    };

    async function cargarDatosAdmin() {
      try {
        let { data: nidos, error } = await globalSupabase.from('nidos').select('*');
        
        if (error) {
          console.error('Error cargando nidos:', error);
          return;
        }

        // Cargar tabla de nidos
        const tbody = document.getElementById('nidosTableBody');
        tbody.innerHTML = '';

        if (!nidos || nidos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">No hay nidos registrados</td></tr>';
          actualizarEstadisticas([]);
          return;
        }

        nidos.forEach(nido => {
          const fecha = new Date(nido.created_at || nido.id).toLocaleDateString();
          const reports = nido.reports_count || 0;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${nido.id}</td>
            <td>${nido.tipo}</td>
            <td>${nido.lat.toFixed(4)}, ${nido.lng.toFixed(4)}</td>
            <td>${nido.user_id.substring(0, 20)}...</td>
            <td>${fecha}</td>
            <td><span style="background-color: ${reports > 0 ? '#ffcccc' : '#ccffcc'}; padding: 4px 8px; border-radius: 3px;">${reports}</span></td>
            <td>
              <button class="admin-view-btn" onclick="verDetallesNido('${nido.id}')">Ver</button>
              <button class="admin-delete-btn" onclick="eliminarNidoAdmin('${nido.id}')">Eliminar</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        actualizarEstadisticas(nidos);
      } catch (e) {
        console.error('Error en cargarDatosAdmin:', e);
      }
    }

    window.eliminarNidoAdmin = async function(nidoId) {
      if (confirm('¿Estás seguro de que deseas eliminar este nido?')) {
        try {
          let { error } = await globalSupabase.from('nidos').delete().eq('id', nidoId);
          if (error) {
            alert('Error eliminando nido: ' + error.message);
          } else {
            alert('Nido eliminado correctamente');
            cargarDatosAdmin();
            window.cargarNidos();
          }
        } catch (e) {
          console.error('Error eliminando:', e);
        }
      }
    };

    window.verDetallesNido = function(nidoId) {
      alert('Detalles del nido: ' + nidoId);
    };

    function actualizarEstadisticas(nidos) {
      const totalNidos = nidos.length;
      const golondrinas = nidos.filter(n => n.tipo === 'Golondrina').length;
      const otrosNidos = nidos.filter(n => n.tipo === 'Otro').length;
      const usuarios = new Set(nidos.map(n => n.user_id)).size;

      document.getElementById('statTotalNidos').textContent = totalNidos;
      document.getElementById('statGolondrinas').textContent = golondrinas;
      document.getElementById('statOtrosNidos').textContent = otrosNidos;
      document.getElementById('statUsuarios').textContent = usuarios;

      // Estadísticas por usuario
      const usuariosMap = {};
      nidos.forEach(nido => {
        if (!usuariosMap[nido.user_id]) {
          usuariosMap[nido.user_id] = 0;
        }
        usuariosMap[nido.user_id]++;
      });

      const statsUsersDiv = document.getElementById('statsUsers');
      statsUsersDiv.innerHTML = '';
      
      Object.entries(usuariosMap)
        .sort((a, b) => b[1] - a[1])
        .forEach(([userId, count]) => {
          const div = document.createElement('div');
          div.style.cssText = 'padding: 10px; margin: 5px 0; background-color: #f9f9f9; border-radius: 4px; display: flex; justify-content: space-between;';
          div.innerHTML = `<span>${userId.substring(0, 30)}...</span><strong>${count} nido${count !== 1 ? 's' : ''}</strong>`;
          statsUsersDiv.appendChild(div);
        });
    }

    async function cargarReportes() {
      try {
        let { data: nidos, error } = await globalSupabase.from('nidos').select('*').gt('reports_count', 0).order('reports_count', { ascending: false });
        
        if (error) {
          console.error('Error cargando reportes:', error);
          return;
        }

        const container = document.getElementById('reportesContainer');
        container.innerHTML = '';

        if (!nidos || nidos.length === 0) {
          container.innerHTML = '<p style="color: #666;">No hay nidos reportados</p>';
          return;
        }

        nidos.forEach(nido => {
          const div = document.createElement('div');
          div.className = 'report-section';
          div.innerHTML = `
            <strong>Nido ID:</strong> ${nido.id}<br>
            <strong>Tipo:</strong> ${nido.tipo}<br>
            <strong>Ubicación:</strong> ${nido.lat.toFixed(4)}, ${nido.lng.toFixed(4)}<br>
            <strong>Reportes:</strong> <span style="color: red; font-weight: bold;">${nido.reports_count || 0}</span><br>
            <strong>Usuario:</strong> ${nido.user_id}<br>
            <img src="${nido.foto_url}" style="width: 150px; height: auto; margin-top: 10px; border-radius: 4px;"><br>
            <button class="admin-delete-btn" style="margin-top: 10px;" onclick="eliminarNidoAdmin('${nido.id}')">Eliminar Nido</button>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error('Error en cargarReportes:', e);
      }
    }

    // Funciones para el Panel de Información
    async function cargarEstadisticasInfo() {
      try {
        let { data: nidos, error } = await globalSupabase.from('nidos').select('*');
        
        if (error) {
          console.error('Error cargando nidos:', error);
          return;
        }

        if (!nidos) nidos = [];
        
        const totalNidos = nidos.length;
        const golondrinas = nidos.filter(n => n.tipo === 'Golondrina').length;
        const otrosNidos = nidos.filter(n => n.tipo === 'Otro').length;

        document.getElementById('infoStatTotalNidos').textContent = totalNidos;
        document.getElementById('infoStatGolondrinas').textContent = golondrinas;
        document.getElementById('infoStatOtrosNidos').textContent = otrosNidos;
      } catch (e) {
        console.error('Error en cargarEstadisticasInfo:', e);
      }
    }

    window.abrirInfoPanel = function() {
      document.getElementById('infoPanel').classList.add('active');
      cargarEstadisticasInfo();
    };

    window.cerrarInfoPanel = function() {
      document.getElementById('infoPanel').classList.remove('active');
    };

    // Cerrar panel de información al hacer clic fuera de él
    document.getElementById('infoPanel').addEventListener('click', function(e) {
      if (e.target === this) {
        window.cerrarInfoPanel();
      }
    });

    // Atajo de teclado para abrir panel admin
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.shiftKey && event.key === 'A') {
        window.abrirAdminPanel();
      }
    });

    // Llamar a inicializar cuando el documento esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializar);
    } else {
      inicializar();
    }
  </script>
</body>
</html>
